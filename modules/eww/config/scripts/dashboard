#!/usr/bin/env bash
set -euo pipefail

CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/eww"
CONFIG_DIR="${EWW_CONFIG_DIR:-$HOME/.config/eww}"
mkdir -p "$CACHE_DIR"

clamp_0_100() { awk -v n="${1:-0}" 'BEGIN{ if(n<0) n=0; if(n>100) n=100; printf "%d\n", n }'; }

cpu_usage() {
  read -r total_now idle_now < <(awk 'NR==1{idle=$5+$6; nonidle=$2+$3+$4+$7+$8; total=idle+nonidle; print total, idle; exit}' /proc/stat)
  prev="$CACHE_DIR/cpu_prev"
  if [[ -f "$prev" ]]; then read -r total_prev idle_prev < "$prev"; else total_prev="$total_now"; idle_prev="$idle_now"; fi
  echo "$total_now $idle_now" > "$prev"
  awk -v tn="$total_now" -v inow="$idle_now" -v tp="$total_prev" -v ip="$idle_prev" 'BEGIN{
    dt=tn-tp; di=inow-ip; if(dt<=0){print 0; exit}
    u=(dt-di)*100/dt; if(u<0)u=0; if(u>100)u=100; printf "%d\n", u
  }'
}

mem_usage() {
  awk '
    $1=="MemTotal:"{t=$2}
    $1=="MemAvailable:"{a=$2}
    END{ if(t<=0){print 0; exit}
         u=(t-a)*100/t; if(u<0)u=0; if(u>100)u=100; printf "%d\n", u }' /proc/meminfo
}

disk_usage() { df -P / | awk 'NR==2{gsub("%","",$5); print $5; exit}'; }

temp_usage() {
  local t=""
  if command -v sensors >/dev/null 2>&1; then
    t="$(sensors 2>/dev/null | awk '
      /Package id 0:|Tctl:|temp1:/{
        for(i=1;i<=NF;i++){
          if($i ~ /^\+?[0-9]+(\.[0-9]+)?°C$/){ gsub(/[+°C]/,"",$i); print $i; exit }
        }
      }')"
  fi
  if [[ -z "${t:-}" ]]; then
    for f in /sys/class/thermal/thermal_zone*/temp; do
      [[ -r "$f" ]] || continue
      raw="$(cat "$f" 2>/dev/null || true)"
      [[ -n "$raw" ]] || continue
      if [[ "$raw" -gt 1000 ]]; then t="$(awk -v r="$raw" 'BEGIN{printf "%.1f", r/1000}')"; else t="$raw"; fi
      break
    done
  fi
  [[ -z "${t:-}" ]] && { echo 0; return; }
  clamp_0_100 "$(awk -v x="$t" 'BEGIN{printf "%d", (x+0.5)}')"
}

uptime_short() {
  s="$(awk '{print int($1)}' /proc/uptime || echo 0)"
  m=$((s/60)); h=$((m/60)); d=$((h/24))
  m=$((m%60)); h=$((h%24))
  if (( d > 0 )); then printf "%dd %dh\n" "$d" "$h"
  elif (( h > 0 )); then printf "%dh %dm\n" "$h" "$m"
  else printf "%dm\n" "$m"; fi
}

battery_pct() { command -v acpi >/dev/null 2>&1 && acpi -b | awk -F'[, %]+' 'NR==1{print $3; exit}' || echo 0; }

vol_get() { pamixer --get-volume 2>/dev/null || echo 0; }
vol_muted() { pamixer --get-mute 2>/dev/null || echo false; }
vol_set() { pamixer --set-volume "$(clamp_0_100 "${1:-0}")" >/dev/null 2>&1 || true; }
vol_toggle_mute() { pamixer -t >/dev/null 2>&1 || true; }

bri_get() { brightnessctl -m 2>/dev/null | awk -F',' 'NR==1{gsub("%","",$4); print $4; exit}' || echo 0; }
bri_set() { brightnessctl set "$(clamp_0_100 "${1:-0}")%" >/dev/null 2>&1 || true; }

wifi_on() { nmcli -t -f WIFI general | grep -qi enabled && echo true || echo false; }
wifi_ssid() { nmcli -t -f ACTIVE,SSID dev wifi | awk -F: '$1=="yes"{print $2; exit}'; }
wifi_toggle() { [[ "$(wifi_on)" == "true" ]] && nmcli radio wifi off || nmcli radio wifi on; }

bt_on() { bluetoothctl show | awk -F': ' '/Powered/{print $2}' | grep -qi yes && echo true || echo false; }
bt_toggle() { [[ "$(bt_on)" == "true" ]] && bluetoothctl power off || bluetoothctl power on; }

player_status() { playerctl status 2>/dev/null || echo "Stopped"; }
player_title()  { playerctl metadata title 2>/dev/null || echo "No media"; }
player_artist() { playerctl metadata artist 2>/dev/null || echo ""; }

player_art() {
  local fallback="${CONFIG_DIR}/assets/cover.svg"
  url="$(playerctl metadata mpris:artUrl 2>/dev/null || true)"
  [[ -z "${url:-}" ]] && { echo "$fallback"; return; }

  out="$CACHE_DIR/art"
  urlfile="$CACHE_DIR/art_url"
  prev="$(cat "$urlfile" 2>/dev/null || true)"

  if [[ "$prev" == "$url" && -f "$out" ]]; then
    echo "$out"
    return
  fi

  echo "$url" > "$urlfile"

  case "$url" in
    file://*) echo "${url#file://}" ;;
    http://*|https://*)
      curl -L -s -o "$out" "$url" >/dev/null 2>&1 || true
      [[ -f "$out" ]] && echo "$out" || echo "$fallback"
      ;;
    *) echo "$fallback" ;;
  esac
}

agenda_get() {
  if command -v khal >/dev/null 2>&1; then
    khal list today 2>/dev/null | head -n 5
  else
    echo "No events"
  fi
}

case "${1:-}" in
  cpu) cpu_usage ;;
  mem) mem_usage ;;
  disk) clamp_0_100 "$(disk_usage)" ;;
  temp) temp_usage ;;
  uptime) uptime_short ;;
  battery) clamp_0_100 "$(battery_pct)" ;;

  wifi) case "${2:-}" in on) wifi_on ;; ssid) wifi_ssid ;; toggle) wifi_toggle ;; esac ;;
  bluetooth) case "${2:-}" in on) bt_on ;; toggle) bt_toggle ;; esac ;;

  volume) case "${2:-}" in get) vol_get ;; muted) vol_muted ;; set) vol_set "${3:-0}" ;; mute-toggle) vol_toggle_mute ;; esac ;;
  brightness) case "${2:-}" in get) bri_get ;; set) bri_set "${3:-0}" ;; esac ;;

  player)
    case "${2:-}" in
      status) player_status ;;
      title) player_title ;;
      artist) player_artist ;;
      art) player_art ;;
      playpause) playerctl play-pause 2>/dev/null || true ;;
      next) playerctl next 2>/dev/null || true ;;
      prev) playerctl previous 2>/dev/null || true ;;
    esac
    ;;

  agenda) agenda_get ;;
  poweroff) loginctl poweroff ;;
  reboot) loginctl reboot ;;
  suspend) loginctl suspend ;;
  lock) swaylock -f ;;
  refresh) eww reload 2>/dev/null || true ;;
  *) echo "" ;;
esac
