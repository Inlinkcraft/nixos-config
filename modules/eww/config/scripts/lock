#!/usr/bin/env bash
set -euo pipefail

# Close the overlay first so it doesn't stack above the lock / steal focus
eww close-all 2>/dev/null || true
sleep 0.1

# Load pywal colors safely (colors.sh may reference unset vars like FZF_DEFAULT_OPTS)
WAL="$HOME/.cache/wal/colors.sh"
if [[ -f "$WAL" ]]; then
  set +u
  # shellcheck disable=SC1090
  source "$WAL"
  set -u
fi

# Fallbacks if pywal isn't ready
: "${foreground:=#ffffff}"
: "${background:=#000000}"
: "${color4:=#bd93f9}"
: "${color1:=#ff5555}"

strip() { echo "${1#\#}"; }
a() { echo "${1}${2}"; }  # rrggbb + aa

FG="$(strip "$foreground")"
BG="$(strip "$background")"
ACCENT="$(strip "$color4")"
WARN="$(strip "$color1")"

WALL="$HOME/.cache/current_wallpaper"

# Prefer wallpaper mode (theme switcher should keep this symlink updated)
if [[ -e "$WALL" ]]; then
  BG_ARGS=(--image "$WALL")
else
  # Fallback to screenshot mode if wallpaper link isn't available
  BG_ARGS=(--screenshots)
fi

# Detach from eww just in case (helps when launched from UI)
# If setsid isn't available, it will just run normally.
if command -v setsid >/dev/null 2>&1; then
  exec setsid -f swaylock -f \
    "${BG_ARGS[@]}" \
    --effect-blur 10x6 \
    --effect-vignette 0.25:0.25 \
    --fade-in 0.2 \
    --clock --indicator \
    --text-color "$FG" \
    --inside-color "$(a "$BG" "88")" \
    --ring-color "$(a "$ACCENT" "cc")" \
    --key-hl-color "$(a "$ACCENT" "ff")" \
    --bs-hl-color "$(a "$WARN" "ff")" \
    --inside-wrong-color "$(a "$WARN" "66")" \
    --ring-wrong-color "$(a "$WARN" "ff")"
else
  exec swaylock -f \
    "${BG_ARGS[@]}" \
    --effect-blur 10x6 \
    --effect-vignette 0.25:0.25 \
    --fade-in 0.2 \
    --clock --indicator \
    --text-color "$FG" \
    --inside-color "$(a "$BG" "88")" \
    --ring-color "$(a "$ACCENT" "cc")" \
    --key-hl-color "$(a "$ACCENT" "ff")" \
    --bs-hl-color "$(a "$WARN" "ff")" \
    --inside-wrong-color "$(a "$WARN" "66")" \
    --ring-wrong-color "$(a "$WARN" "ff")"
fi
