#!/usr/bin/env bash
set -euo pipefail

key="${1:-}"

num() { # clamp to 0-100
  local v="${1:-0}"
  [[ "$v" =~ ^[0-9]+([.][0-9]+)?$ ]] || v="0"
  v="${v%.*}"
  (( v < 0 )) && v=0
  (( v > 100 )) && v=100
  echo "$v"
}

case "$key" in
  cpu)
    # CPU usage %
    read -r cpu user nice system idle iowait irq softirq steal guest guest_nice < /proc/stat
    prev_idle=$((idle+iowait))
    prev_total=$((user+nice+system+idle+iowait+irq+softirq+steal))
    sleep 0.25
    read -r cpu2 user2 nice2 system2 idle2 iowait2 irq2 softirq2 steal2 guest2 guest_nice2 < /proc/stat
    idle_now=$((idle2+iowait2))
    total_now=$((user2+nice2+system2+idle2+iowait2+irq2+softirq2+steal2))
    diff_idle=$((idle_now-prev_idle))
    diff_total=$((total_now-prev_total))
    if (( diff_total <= 0 )); then echo 0; exit 0; fi
    usage=$(( (100*(diff_total-diff_idle))/diff_total ))
    num "$usage"
    ;;

  ram)
    # RAM usage %
    mem_total=$(awk '/MemTotal/ {print $2}' /proc/meminfo || echo 0)
    mem_avail=$(awk '/MemAvailable/ {print $2}' /proc/meminfo || echo 0)
    if (( mem_total <= 0 )); then echo 0; exit 0; fi
    used=$((mem_total-mem_avail))
    pct=$(( (100*used)/mem_total ))
    num "$pct"
    ;;

  disk)
    # Root disk usage %
    pct=$(df -P / | awk 'NR==2 {gsub(/%/,"",$5); print $5}' || echo 0)
    num "$pct"
    ;;

  temp)
    # Temperature °C (best effort)
    if command -v sensors >/dev/null 2>&1; then
      t=$(sensors 2>/dev/null | awk '
        /Package id 0:/ {gsub(/\+|°C/,"",$4); print $4; exit}
        /Tctl:/ {gsub(/\+|°C/,"",$2); print $2; exit}
      ')
      t="${t:-0}"
      t="${t%.*}"
      [[ "$t" =~ ^-?[0-9]+$ ]] || t="0"
      echo "$t"
    else
      echo 0
    fi
    ;;

  vol)
    if command -v pactl >/dev/null 2>&1; then
      v=$(pactl get-sink-volume @DEFAULT_SINK@ 2>/dev/null | awk 'NR==1 {gsub(/%/,"",$5); print $5}')
      num "${v:-0}"
    else
      echo 0
    fi
    ;;

  bright)
    if command -v brightnessctl >/dev/null 2>&1; then
      v=$(brightnessctl -m 2>/dev/null | awk -F',' '{gsub(/%/,"",$4); print $4}')
      num "${v:-0}"
    else
      echo 0
    fi
    ;;

  *)
    echo 0
    ;;
esac
