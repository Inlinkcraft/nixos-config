#!/usr/bin/env bash
set -euo pipefail

cmd="${1:-}"

case "$cmd" in
  cpu)
    # CPU usage percentage (works on most Linux)
    read -r cpu user nice sys idle iowait irq softirq steal guest guest_nice < /proc/stat
    prev_total=$((user+nice+sys+idle+iowait+irq+softirq+steal))
    prev_idle=$((idle+iowait))
    sleep 0.2
    read -r cpu2 user2 nice2 sys2 idle2 iowait2 irq2 softirq2 steal2 guest2 guest_nice2 < /proc/stat
    total=$((user2+nice2+sys2+idle2+iowait2+irq2+softirq2+steal2))
    idle_t=$((idle2+iowait2))

    totald=$((total-prev_total))
    idled=$((idle_t-prev_idle))

    if [ "$totald" -le 0 ]; then
      echo 0
    else
      echo $(( (100*(totald-idled)) / totald ))
    fi
    ;;

  mem)
    # RAM used %
    mem_total=$(awk '/MemTotal/ {print $2}' /proc/meminfo)
    mem_avail=$(awk '/MemAvailable/ {print $2}' /proc/meminfo)
    if [ -z "${mem_total}" ] || [ -z "${mem_avail}" ] || [ "${mem_total}" -le 0 ]; then
      echo 0
    else
      used=$((mem_total-mem_avail))
      echo $(( (100*used)/mem_total ))
    fi
    ;;

  disk)
    # Root disk used %
    df_out=$(df -P / | awk 'NR==2 {print $5}' | tr -d '%')
    echo "${df_out:-0}"
    ;;

  temp)
    # Try sensors first, fallback to thermal zone
    if command -v sensors >/dev/null 2>&1; then
      t=$(sensors 2>/dev/null | awk '
        /Package id 0:/ {gsub(/[+°C]/,"",$4); print int($4); exit}
        /Tctl:/ {gsub(/[+°C]/,"",$2); print int($2); exit}
      ')
      if [ -n "${t:-}" ]; then
        echo "$t"
        exit 0
      fi
    fi

    # thermal zone fallback
    if [ -f /sys/class/thermal/thermal_zone0/temp ]; then
      raw=$(cat /sys/class/thermal/thermal_zone0/temp)
      echo $((raw/1000))
    else
      echo 0
    fi
    ;;

  *)
    echo 0
    ;;
esac
